<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiDesk Remote Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #7b4397;
            --secondary-color: #dc2430;
            --bg-start: #1e0033;
            --bg-end: #3f004b;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #f0f0f0;
            --text-secondary: #c0c0c0;
            --accent-glow: rgba(123, 67, 151, 0.7);
            --online-color: #28a745;
            --limited-color: #ffc107;
            --offline-color: #6c757d;
            --border-radius-lg: 16px;
            --border-radius-md: 10px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); } to { transform: translateY(0); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
            animation: fadeIn 0.5s ease-out, slideUp 0.5s ease-out;
        }

        .panel-container {
            position: relative;
        }
        
        .panel {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(12px);
            margin-bottom: 25px;
            transition: opacity var(--transition-speed) ease-in-out, transform var(--transition-speed) ease-in-out;
            will-change: transform, opacity;
        }
        
        .panel.hidden {
            opacity: 0;
            transform: scale(0.98);
            pointer-events: none;
            position: absolute;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        h1 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 2.2rem;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .header-actions { display: flex; gap: 15px; }

        .btn {
            padding: 12px 24px;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            transition: all var(--transition-speed) ease;
            text-decoration: none;
            font-size: 14px;
            background: var(--glass-bg);
            color: var(--text-primary);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); border: none; }
        .btn-primary:hover { box-shadow: 0 5px 20px rgba(220, 36, 48, 0.4); }

        .panel-header {
            color: var(--text-primary);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.8rem;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 15px;
        }

        /* --- Client List Styles --- */
        .clients-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .client-card {
            padding: 25px;
            border-radius: var(--border-radius-md);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
            background-color: var(--glass-bg);
            border-color: var(--glass-border);
            animation: fadeIn 0.5s ease-out forwards, slideUp 0.5s ease-out forwards;
            opacity: 0;
        }

        .client-card.clickable:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .client-card::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            filter: blur(80px);
            opacity: 0;
            transition: opacity var(--transition-speed) ease;
        }
        
        .client-card.online-full::before { background: var(--online-color); }
        .client-card.online-limited::before { background: var(--limited-color); }
        .client-card.clickable:hover::before { opacity: 0.3; }
        .client-card.offline { cursor: not-allowed; color: var(--text-secondary); opacity: 0.7; }

        .client-status-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            margin-right: 12px;
            box-shadow: 0 0 8px;
        }
        .online-full .client-status-dot { background-color: var(--online-color); box-shadow-color: var(--online-color); }
        .online-limited .client-status-dot { background-color: var(--limited-color); box-shadow-color: var(--limited-color); }
        .offline .client-status-dot { background-color: var(--offline-color); box-shadow-color: var(--offline-color); }
        
        .client-info h3 { font-size: 1.2rem; margin-bottom: 8px; display: flex; align-items: center; }
        .client-info p { font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4; }

        /* --- File Browser Styles --- */
        .browser-header {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .browser-nav { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            background: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: var(--border-radius-md);
            font-family: 'Consolas', monospace;
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
            font-size: 14px;
            flex: 1;
            min-width: 0;
            overflow-x: auto;
        }
        .breadcrumb ol { list-style: none; display: flex; align-items: center; white-space: nowrap; }
        .breadcrumb li:not(:last-child)::after { content: '>'; margin: 0 8px; opacity: 0.5; }
        .breadcrumb a { color: var(--text-primary); text-decoration: none; transition: color var(--transition-speed); }
        .breadcrumb a:hover { color: var(--primary-color); text-decoration: underline; }

        .file-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
 margin-bottom: 25px;
        }
        
        .search-box {
            position: relative;
            flex-grow: 1;
            max-width: 400px;
        }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        #searchInput {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--glass-border);
            background: rgba(0,0,0,0.2);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all var(--transition-speed) ease;
        }
        #searchInput:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px var(--accent-glow); }

        .control-group { display: flex; align-items: center; gap: 10px; }
        .control-group label { font-weight: 500; color: var(--text-secondary); }

        select, input[type="checkbox"] {
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-md);
            background: rgba(0,0,0,0.2);
            color: var(--text-primary);
            transition: border-color var(--transition-speed) ease;
        }
        select { padding: 10px 15px; }
        select:focus { outline: none; border-color: var(--primary-color); }
        
        .file-list {
            min-height: 400px;
            max-height: 65vh;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-lg);
            background: rgba(0,0,0,0.1);
        }
/* --- Elegant Toggle Switch for 'Hide Folders' --- */

/* First, we target the control group's label to ensure proper alignment */
.control-group label[for="hideFolders"],
.control-group input[type="checkbox"]#hideFolders {
    cursor: pointer;
}
.control-group label {
    display: inline-flex;
    align-items: center;
    user-select: none; /* Prevents text selection on click */
}

/* Hide the original, ugly checkbox but keep it functional */
input[type="checkbox"]#hideFolders {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    position: relative;
    width: 52px;
    height: 30px;
    border-radius: 15px; /* Fully rounded */
    background: rgba(0, 0, 0, 0.25); /* Dark, transparent background */
    border: 1px solid var(--glass-border);
    transition: all 0.3s ease-in-out;
    margin-right: 12px; /* Space between switch and text */
}

/* Create the circular 'thumb' that slides */
input[type="checkbox"]#hideFolders::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background-color: var(--text-secondary);
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
    transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
}

/* Add a glowing effect on hover, consistent with the site's theme */
input[type="checkbox"]#hideFolders:hover {
    box-shadow: 0 0 10px var(--accent-glow);
}

/* --- STYLES FOR THE 'CHECKED' (ON) STATE --- */

/* Change the background to the site's primary gradient when checked */
input[type="checkbox"]#hideFolders:checked {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    border-color: transparent;
}

/* Slide the thumb to the right and make it bright white */
input[type="checkbox"]#hideFolders:checked::before {
    transform: translateX(22px);
    background-color: #ffffff;
}
/* --- Custom Styled Select Dropdown --- */

/* Style the wrapper we added in the HTML */
.select-wrapper {
    position: relative; /* Anchor for the custom arrow */
    display: inline-block;
}

/* Style the main select box to match the site's theme */
#sortSelect {
    /* Remove default browser appearance */
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;

    /* Apply custom glassmorphism styles */
    background-color: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    outline: none;
    transition: all var(--transition-speed) ease;
    
    /* Add padding: extra on the right for the custom arrow */
    padding: 10px 40px 10px 15px;
    min-width: 180px; /* Give it a nice default width */
}

/* Create the custom dropdown arrow using Font Awesome */
.select-wrapper::after {
    content: '\f078'; /* Font Awesome's chevron-down icon */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900; /* Use the solid version of the icon */
    font-size: 14px;
    
    color: var(--text-secondary);
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    pointer-events: none; /* Allows clicks to pass through to the select box */
    transition: all var(--transition-speed) ease;
}

/* Hover & Focus states for a responsive feel */
.select-wrapper:hover #sortSelect {
    border-color: rgba(255, 255, 255, 0.4);
}

.select-wrapper:hover::after {
    color: var(--text-primary);
}

#sortSelect:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--accent-glow);
}

/* Style the dropdown options list to be dark */
#sortSelect option {
    background-color: var(--bg-end);
    color: var(--text-primary);
    padding: 10px; /* Note: padding on options is not supported everywhere */
}

/* Finally, style the label for consistency */
label[for="sortSelect"] {
    font-weight: 600;
    color: var(--text-secondary);
    margin-right: 5px; /* A little space between label and dropdown */
}
        .file-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease;
            border-bottom: 1px solid var(--glass-border);
            opacity: 0;
            transform: translateY(10px);
            animation: fadeIn 0.3s ease-out forwards, slideUp 0.3s ease-out forwards;
        }
        .file-item:last-child { border-bottom: none; }
        .file-item:hover { background: var(--glass-bg); }
        
        .file-icon { font-size: 20px; margin-right: 20px; width: 30px; text-align: center; }
        .file-item.folder .file-icon { color: #5dade2; }
        
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-weight: 500; word-break: break-all; }
        .file-details { font-size: 13px; color: var(--text-secondary); }
        
        /* --- Skeleton Loader --- */
        .skeleton-item { display: flex; align-items: center; padding: 14px 20px; border-bottom: 1px solid var(--glass-border); }
        .skeleton-icon { width: 30px; height: 24px; margin-right: 20px; background: rgba(255,255,255,0.1); border-radius: 4px; animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-text { flex: 1; }
        .skeleton-line { height: 16px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 8px; animation: pulse 1.5s infinite ease-in-out; }
        .skeleton-line.short { width: 30%; height: 12px; margin-bottom: 0; }

        /* --- Pagination --- */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 25px; }
        .pagination button { /* Styles from .btn */ }

        /* --- Status & Toasts --- */
        .status-message { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .status-message i { font-size: 3rem; margin-bottom: 15px; display: block; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .toast {
            padding: 15px 20px;
            border-radius: var(--border-radius-md);
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            opacity: 0;
            transform: translateX(100%);
            animation: slideInToast 0.5s forwards, fadeOutToast 0.5s 4.5s forwards;
        }
        @keyframes slideInToast { to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOutToast { to { opacity: 0; transform: translateX(100%); } }
        .toast.success { background: linear-gradient(135deg, #28a745, #218838); }
        .toast.error { background: linear-gradient(135deg, #dc3545, #c82333); }
        .toast.info { background: linear-gradient(135deg, #17a2b8, #138496); }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            h1 { font-size: 1.8rem; }
            .header { flex-direction: column; text-align: center; }
            .file-controls, .browser-nav { flex-direction: column; align-items: stretch; }
            .search-box { max-width: none; }
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--glass-border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header panel">
            <h1><i class="fas fa-satellite-dish"></i> GeminiDesk</h1>
            <div class="header-actions">
                <button id="refreshBtn" class="btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                <button id="healthBtn" class="btn"><i class="fas fa-heart-pulse"></i> Health Check</button>
            </div>
        </header>

        <main class="panel-container">
            <!-- Client List Panel -->
            <section class="panel" id="clientPanel">
                <h2 class="panel-header"><i class="fas fa-network-wired"></i> Connected Devices</h2>
                <div id="clientList" class="clients-grid">
                    <!-- Skeleton Loader for Clients -->
                </div>
            </section>

            <!-- File Browser Panel -->
            <section class="panel hidden" id="browserPanel">
                <div class="browser-header">
                    <h2 id="browserTitle" class="panel-header">File Browser</h2>
                    <nav class="browser-nav">
                        <button id="backToDevicesBtn" class="btn"><i class="fas fa-arrow-left"></i> Devices</button>
                        <button id="upDirectoryBtn" class="btn"><i class="fas fa-arrow-up"></i> Up</button>
                        <div class="breadcrumb" id="breadcrumbNav"><ol></ol></div>
                    </nav>
                </div>

                <div class="file-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Filter files and folders...">
                    </div>
<div class="control-group">
    <label for="sortSelect">Sort by:</label>
    <!-- The new wrapper div starts here -->
    <div class="select-wrapper">
        <select id="sortSelect">
            <option value="name_asc">Name (A-Z)</option>
            <option value="name_desc">Name (Z-A)</option>
            <option value="date_desc">Date (Newest)</option>
            <option value="date_asc">Date (Oldest)</option>
            <option value="size_desc">Size (Largest)</option>
            <option value="size_asc">Size (Smallest)</option>
        </select>
    </div>
    <!-- The new wrapper div ends here -->
</div>
                    <div class="control-group">
                        <label><input type="checkbox" id="hideFolders"> Hide Folders</label>
                    </div>
                </div>

                <div id="fileList" class="file-list">
                    <!-- Skeleton Loader for Files -->
                </div>

                <div class="pagination" id="pagination"></div>
            </section>
        </main>
    </div>
    <div id="toast-container"></div>

    <script>
        class GeminiDeskDashboard {
            constructor() {
                this.serverUrl = 'https://latex-v25b.onrender.com';
                this.currentClient = null;
                this.currentPath = '';
                this.currentPage = 1;
                this.itemsPerPage = 50;
                this.currentSort = 'name_asc';
                this.hideFolders = false;
                this.currentFilter = '';
                this.fileCache = new Map();

                this.init();
            }

            init() {
                this.bindEvents();
                this.loadClients();
            }

            bindEvents() {
                document.getElementById('refreshBtn').addEventListener('click', () => this.loadClients());
                document.getElementById('healthBtn').addEventListener('click', () => this.checkHealth());
                document.getElementById('backToDevicesBtn').addEventListener('click', () => this.showPanel('clientPanel'));
                document.getElementById('upDirectoryBtn').addEventListener('click', () => this.navigateUp());

                const sortSelect = document.getElementById('sortSelect');
                sortSelect.addEventListener('change', () => {
                    this.currentSort = sortSelect.value;
                    this.renderFileList();
                });

                const hideFoldersCheckbox = document.getElementById('hideFolders');
                hideFoldersCheckbox.addEventListener('change', () => {
                    this.hideFolders = hideFoldersCheckbox.checked;
                    this.renderFileList();
                });
                
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('keyup', () => {
                    this.currentFilter = searchInput.value.toLowerCase();
                    this.renderFileList();
                });

                document.getElementById('clientList').addEventListener('click', e => {
                    const card = e.target.closest('.client-card.clickable');
                    if (card) {
                        this.selectClient(card.dataset.id, card.dataset.name);
                    }
                });

                document.getElementById('fileList').addEventListener('click', e => {
                    const item = e.target.closest('.file-item');
                    if (!item) return;

                    const { path, type, name } = item.dataset;
                    if (type === 'dir') {
                        this.loadDirectory(path);
                    } else if (type === 'file') {
                        this.downloadFile(path, name, item);
                    }
                });
                
                document.getElementById('breadcrumbNav').addEventListener('click', e => {
                    e.preventDefault();
                    const link = e.target.closest('a');
                    if(link && link.dataset.path) {
                        this.loadDirectory(link.dataset.path);
                    }
                });
            }

            async fetchWithTimeout(url, options = {}, timeout = 20000) {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), timeout);
                const response = await fetch(url, { ...options, signal: controller.signal });
                clearTimeout(id);
                return response;
            }

            async loadClients() {
                const clientList = document.getElementById('clientList');
                this.renderSkeleton(clientList, 'client');
                try {
                    const response = await this.fetchWithTimeout(`${this.serverUrl}/api/clients`);
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const data = await response.json();
                    if (data.success) {
                        this.renderClientList(data.clients);
                    } else {
                        throw new Error(data.error || 'Failed to load clients');
                    }
                } catch (error) {
                    this.showError(clientList, `Failed to load devices: ${error.message}`);
                    this.showToast('error', 'Could not fetch devices.');
                }
            }
            
            async checkHealth() {
                try {
                    const response = await this.fetchWithTimeout(`${this.serverUrl}/api/health`);
                     if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const data = await response.json();
                    if (data.success) {
                        this.showToast('success', `Server OK | ${data.clients.activeWebSockets} active connections.`);
                    } else {
                        throw new Error('Health check failed');
                    }
                } catch (error) {
                    this.showToast('error', `Health check failed: ${error.message}`);
                }
            }
            
            renderClientList(clients) {
                const clientList = document.getElementById('clientList');
                if (clients.length === 0) {
                    clientList.innerHTML = `<div class="status-message"><i class="fas fa-ghost"></i>No devices connected.</div>`;
                    return;
                }
                clientList.innerHTML = clients.map((client, index) => {
                    const isClickable = client.canControl;
                    return `
                        <div class="client-card ${client.status} ${isClickable ? 'clickable' : ''}" 
                             data-id="${client.id}" data-name="${this.escapeHtml(client.name)}"
                             style="animation-delay: ${index * 50}ms">
                            <div class="client-info">
                                <h3><span class="client-status-dot"></span>${this.escapeHtml(client.name)}</h3>
                                <p>${client.statusText}<br>ID: ${client.shortId}...</p>
                            </div>
                        </div>`;
                }).join('');
            }
            
            async selectClient(clientId, clientName) {
                this.currentClient = { id: clientId, name: clientName };
                document.getElementById('browserTitle').innerHTML = `<i class="fas fa-desktop"></i> ${clientName}`;
                this.showPanel('browserPanel');
                this.renderSkeleton(document.getElementById('fileList'), 'file');
                this.renderBreadcrumb('');
                
                try {
                    const response = await this.fetchWithTimeout(`${this.serverUrl}/api/client/${clientId}/drives`, { method: 'POST' });
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const driveItems = data.drives.map(drive => ({
                            name: `Drive ${drive}`,
                            path: drive,
                            isDirectory: true,
                            size: 0,
                            birthtime: 0
                        }));
                        this.fileCache.set('drives', driveItems);
                        this.currentPath = 'drives'; // A virtual path for drives
                        this.renderFileList();
                        this.renderBreadcrumb(data.clientName);
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    this.showError(document.getElementById('fileList'), `Failed to load drives: ${error.message}`);
                }
            }

            async loadDirectory(path) {
                if (this.currentPath === path) return;
                this.currentPath = path;
                this.renderSkeleton(document.getElementById('fileList'), 'file');
                this.renderBreadcrumb(path);
                document.getElementById('searchInput').value = '';
                this.currentFilter = '';

                try {
                    const response = await this.fetchWithTimeout(`${this.serverUrl}/api/client/${this.currentClient.id}/list`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path })
                    });
                    if (!response.ok) throw new Error(`Server responded with ${response.status}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.fileCache.set(path, data.items);
                        this.renderFileList();
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    this.showError(document.getElementById('fileList'), `Failed to load directory: ${error.message}`);
                }
            }

            renderFileList() {
                let items = this.fileCache.get(this.currentPath) || [];

                // Filter
                if (this.currentFilter) {
                    items = items.filter(item => item.name.toLowerCase().includes(this.currentFilter));
                }
                if (this.hideFolders) {
                    items = items.filter(item => !item.isDirectory);
                }
                
                // Sort
                items = this.sortItems(items);
                
                // Pagination (for now, let's render all)
                const fileList = document.getElementById('fileList');
                if (items.length === 0) {
                    fileList.innerHTML = `<div class="status-message"><i class="fas fa-folder-open"></i>Directory is empty or filtered out.</div>`;
                } else {
                    fileList.innerHTML = items.map((item, index) => {
                        const icon = item.isDirectory ? 'fas fa-folder' : this.getFileIcon(item.name);
                        const size = item.isDirectory ? 'Folder' : this.formatBytes(item.size);
                        const date = item.birthtime ? new Date(item.birthtime).toLocaleDateString() : '';
                        const details = [size, date].filter(Boolean).join(' • ');
                        
                        return `
                            <div class="file-item ${item.isDirectory ? 'folder' : 'file'}" 
                                 data-path="${this.escapeHtml(item.path)}" 
                                 data-name="${this.escapeHtml(item.name)}"
                                 data-type="${item.isDirectory ? 'dir' : 'file'}"
                                 style="animation-delay: ${index * 15}ms">
                                <div class="file-icon"><i class="${icon}"></i></div>
                                <div class="file-info">
                                    <div class="file-name">${this.escapeHtml(item.name)}</div>
                                    <div class="file-details">${details}</div>
                                </div>
                            </div>`;
                    }).join('');
                }
            }

            sortItems(items) {
                return [...items].sort((a, b) => {
                    if (!this.hideFolders && a.isDirectory !== b.isDirectory) {
                        return a.isDirectory ? -1 : 1;
                    }
                    const [field, dir] = this.currentSort.split('_');
                    const mod = dir === 'asc' ? 1 : -1;
                    
                    if (field === 'name') return a.name.localeCompare(b.name) * mod;
                    if (field === 'date') return (a.birthtime - b.birthtime) * mod;
                    if (field === 'size') return (a.size - b.size) * mod;
                    return 0;
                });
            }

            renderBreadcrumb(path) {
                const breadcrumbNav = document.getElementById('breadcrumbNav').querySelector('ol');
                if (!path || path === 'drives') {
                    breadcrumbNav.innerHTML = `<li>${this.currentClient.name || 'Select a drive'}</li>`;
                    document.getElementById('upDirectoryBtn').style.display = 'none';
                    return;
                }
                
                document.getElementById('upDirectoryBtn').style.display = 'inline-flex';
                
                const parts = path.replace(/\\/g, '/').split('/').filter(Boolean);
                let currentPath = '';
                breadcrumbNav.innerHTML = parts.map((part, i) => {
                    // For Windows drives (e.g., C:), don't append slash
                    currentPath += (i === 0 && part.endsWith(':')) ? part + '\\' : part + '\\';
                    if (i === parts.length - 1) {
                        return `<li>${this.escapeHtml(part)}</li>`;
                    }
                    return `<li><a href="#" data-path="${this.escapeHtml(currentPath)}">${this.escapeHtml(part)}</a></li>`;
                }).join('');
            }

            navigateUp() {
                if (!this.currentPath || this.currentPath === 'drives' || !this.currentPath.includes('\\')) {
                    this.selectClient(this.currentClient.id, this.currentClient.name); // Go back to drives
                    return;
                }
                // Handle cases like C:\ to go back to drives
                if (this.currentPath.endsWith(':\\')) {
                     this.selectClient(this.currentClient.id, this.currentClient.name);
                     return;
                }
                
                const parentPath = this.currentPath.substring(0, this.currentPath.lastIndexOf('\\'));
                // If the parent is just the drive letter (e.g., C:), add the backslash
                if (parentPath.endsWith(':')) {
                    this.loadDirectory(parentPath + '\\');
                } else {
                    this.loadDirectory(parentPath);
                }
            }
            
            async downloadFile(filePath, fileName, element) {
                const originalIcon = element.querySelector('.file-icon').innerHTML;
                element.querySelector('.file-icon').innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
                element.style.pointerEvents = 'none';
                element.style.opacity = '0.7';

                try {
                    this.showToast('info', `Starting download for ${fileName}...`);
                    const response = await this.fetchWithTimeout(`${this.serverUrl}/api/client/${this.currentClient.id}/download`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: filePath })
                    }, 300000); // 5 minute timeout for downloads

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ error: 'Download failed' }));
                        throw new Error(errorData.error);
                    }
                    
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    this.showToast('success', `${fileName} downloaded successfully.`);
                    
                } catch (error) {
                    this.showToast('error', `Download failed: ${error.message}`);
                } finally {
                    element.querySelector('.file-icon').innerHTML = originalIcon;
                    element.style.pointerEvents = 'auto';
                    element.style.opacity = '1';
                }
            }

            // --- UI & Utility Methods ---

            showPanel(panelId) {
                document.querySelectorAll('.panel-container > .panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(panelId).classList.remove('hidden');
            }
            
            renderSkeleton(container, type) {
                const count = type === 'client' ? 6 : 10;
                let skeletonHTML = '';
                for (let i = 0; i < count; i++) {
                    skeletonHTML += type === 'client' ? `
                        <div class="client-card">
                            <div class="skeleton-icon" style="width: 12px; height: 12px; border-radius: 50%; margin-right: 12px;"></div>
                            <div class="skeleton-text">
                                <div class="skeleton-line" style="width: 60%;"></div>
                                <div class="skeleton-line short" style="width: 80%;"></div>
                            </div>
                        </div>` : `
                        <div class="skeleton-item">
                            <div class="skeleton-icon"></div>
                            <div class="skeleton-text">
                                <div class="skeleton-line"></div>
                                <div class="skeleton-line short"></div>
                            </div>
                        </div>`;
                }
                container.innerHTML = skeletonHTML;
            }

            showError(container, message) {
                container.innerHTML = `<div class="status-message"><i class="fas fa-exclamation-triangle"></i>${this.escapeHtml(message)}</div>`;
            }

            showToast(type, message) {
                const toastContainer = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const iconClass = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' }[type];
                toast.innerHTML = `<i class="fas ${iconClass}"></i> ${this.escapeHtml(message)}`;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 5000);
            }

// --- הקוד החדש והמשופר להדבקה ---
getFileIcon(name) {
    const ext = name.split('.').pop().toLowerCase();
    const iconMap = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word', 'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel', 'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint', 'pptx': 'fas fa-file-powerpoint',
        'jpg': 'fas fa-file-image', 'jpeg': 'fas fa-file-image', 'png': 'fas fa-file-image', 'gif': 'fas fa-file-image', 'bmp': 'fas fa-file-image', 'svg': 'fas fa-file-image',
        'mp4': 'fas fa-file-video', 'avi': 'fas fa-file-video', 'mov': 'fas fa-file-video',
        'mp3': 'fas fa-file-audio', 'wav': 'fas fa-file-audio',
        'zip': 'fas fa-file-archive', 'rar': 'fas fa-file-archive', '7z': 'fas fa-file-archive',
        'txt': 'fas fa-file-alt',
        'js': 'fas fa-file-code', 'html': 'fas fa-file-code', 'css': 'fas fa-file-code', 'py': 'fas fa-file-code',
        'exe': 'fas fa-cog'
    };
    // This is the better default icon for any other file type
    return iconMap[ext] || 'fas fa-file-lines';
}            formatBytes = (b,d=2) => {if(0===b)return"0 Bytes";const c=0>d?0:d,e=Math.floor(Math.log(b)/Math.log(1024));return parseFloat((b/Math.pow(1024,e)).toFixed(c))+" "+["Bytes","KB","MB","GB","TB"][e]};
            escapeHtml = (s) => s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);
        }

        document.addEventListener('DOMContentLoaded', () => new GeminiDeskDashboard());
    </script>
</body>
</html>